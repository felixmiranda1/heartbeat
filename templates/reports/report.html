<!DOCTYPE html>
<html lang="pt-br">
{% load dict_extras %}
{% load widget_tweaks %}

<head>
  <meta charset="UTF-8">
  <title>Laudo Ecocardiogr√°fico</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    h1 {
      margin-bottom: 40px;
    }
    h2 {
      margin-top: 30px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
    }
    form {
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      cursor: pointer;
    }
    .divider {
      margin: 40px 0;
      border-top: 2px dashed #ccc;
    }
    .derived-value {
      margin-bottom: 8px;
    }
    .derived-label {
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>Preencher Laudo Ecocardiogr√°fico</h1>

  <form method="post" action="{% url 'reports:create_report' %}">
    {% csrf_token %}

    <!-- Se√ß√£o 1: Dados do Paciente -->
    <h2>1. Dados do Paciente</h2>
    {{ patient_form.as_p }}

    <div class="divider"></div>

    <!-- Se√ß√£o 2: Dados da Consulta -->
    <h2>2. Dados da Consulta</h2>
    {{ appointment_form.as_p }}

    <div class="divider"></div>

    <!-- Se√ß√£o 3: Laudo Num√©rico -->
    <h2>3. Laudo Num√©rico</h2>
    {% for field in measurement_form %}
      <div>
        {{ field.label_tag }}
        {{ field|add_class:"manual-measurement" }}
        {% if field.help_text %}
          <small>{{ field.help_text }}</small>
        {% endif %}
        {% if field.errors %}
          <div style="color: red;">{{ field.errors }}</div>
        {% endif %}
      </div>
    {% endfor %}

    <div class="divider"></div>

    <!-- Se√ß√£o 4: C√°lculos Derivados (Preview) -->
    <h2>4. C√°lculos Derivados (Preview)</h2>
    <div>
      <label>Fra√ß√£o de Eje√ß√£o (Teicholz):</label>
      <span id="fracaoEjecaoTeicholz_result">0.00 %</span>
    </div>

    <div>
      <label>Massa Ventricular Esquerda:</label>
      <span id="massaVE_result">0.00 g</span>
    </div>

    <div>
      <label>VE(d) / Altura:</label>
      <span id="ved_altura_result">0.00</span>
    </div>

    <div class="divider"></div>

    <!-- Se√ß√£o 5: Laudo Descritivo -->
    <h2>5. Laudo Descritivo</h2>
    {% if combined_blocks %}
      <div>
        {{ formset.management_form }}
        {% for form, category in combined_blocks %}
          <div class="report-block">
            <h4>{{ category.name }}</h4>
            {{ form.id }}
            {{ form.content|add_class:"manual-report-block" }}

            {% with grouped_options|get_item:category.id as options %}
              {% if options %}
                <div class="shortcut-options">
                  <strong>Atalhos:</strong>
                  {% for option in options %}
                    <button type="button" class="btn btn-outline-secondary btn-sm insert-option"
                            data-target-id="{{ form.content.id_for_label }}"
                            data-text="{{ option.text }}">
                      {{ option.shortcut_key }} ‚Äî {{ option.text|truncatechars:50 }}
                    </button>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <button type="submit">Salvar Laudo Completo</button>

  </form>

  <script>
// Fun√ß√£o que faz os c√°lculos baseados nos campos preenchidos
function calcularDerivados() {
    // Pegando os valores dos inputs manuais
    const diastoleFinalVe = parseFloat(document.getElementById('id_measurement_7afa3a2b-d414-4fa0-8d82-b941f3f7db36').value) || 0;
    const sistoleFinalVe = parseFloat(document.getElementById('id_measurement_c5326b50-bf6c-46f7-bbec-15748bee04c4').value) || 0;
    const septo = parseFloat(document.getElementById('id_measurement_690b176b-8163-4ce4-82d7-8df8e9df6050').value) || 0;
    const paredePosterior = parseFloat(document.getElementById('id_measurement_846611f4-8e53-4487-83cd-1ca680a2bd48').value) || 0;

    // üßÆ Fra√ß√£o de Eje√ß√£o (Teicholz)
    let fracaoEjecaoTeicholz = 0;
    if (diastoleFinalVe > 0) {
        fracaoEjecaoTeicholz = ((diastoleFinalVe - sistoleFinalVe) / diastoleFinalVe) * 100;
    }

    // üßÆ Massa Ventricular Esquerda
    let massaVE = 0;
    if (diastoleFinalVe && septo && paredePosterior) {
        massaVE = 0.8 * Math.pow((diastoleFinalVe + septo + paredePosterior), 3);
    }

    // üßÆ VE(d) / Altura (considerando altura padr√£o 1.7, se quiser pegar de outro campo, ajusta aqui)
    let vedAltura = 0;
    if (diastoleFinalVe) {
        vedAltura = diastoleFinalVe / 1.7;
    }

    // Exibir resultados nos spans do HTML
    document.getElementById('fracaoEjecaoTeicholz_result').innerText = fracaoEjecaoTeicholz.toFixed(2) + ' %';
    document.getElementById('massaVE_result').innerText = massaVE.toFixed(2) + ' g';
    document.getElementById('ved_altura_result').innerText = vedAltura.toFixed(2);
}

// Adiciona eventos nos inputs manuais
document.querySelectorAll('.manual-measurement').forEach(input => {
    input.addEventListener('input', calcularDerivados);
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('textarea').forEach(textarea => {
      textarea.addEventListener('keyup', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
          let lines = this.value.split('\n');
  
          // Captura a √∫ltima linha com conte√∫do
          let lastLineIndex = lines.length - 1;
          while (lastLineIndex >= 0 && lines[lastLineIndex].trim() === '') {
            lastLineIndex--;
          }
  
          if (lastLineIndex < 0) return;
  
          let lastLine = lines[lastLineIndex].trim();
          const words = lastLine.split(/\s+/);
          const lastWord = words[words.length - 1];
          const textareaId = this.id;
  
          const relatedOptions = Array.from(
            document.querySelectorAll(`.insert-option[data-target-id="${textareaId}"]`)
          );
  
          for (const option of relatedOptions) {
            if (option.innerText.startsWith(lastWord + ' ‚Äî')) {
              // Remove o atalho digitado da linha
              const atalhoRegex = new RegExp(`\\b${lastWord}\\b\\s*$`);
              lastLine = lastLine.replace(atalhoRegex, '').trim();
  
              // Substitui a linha com a frase expandida
              lines[lastLineIndex] = (lastLine + ' ' + option.dataset.text).trim();
  
              // Garante uma linha vazia ao final
              if (lines[lines.length - 1].trim() !== '') {
                lines.push('');
              }
  
              this.value = lines.join('\n');
              break;
            }
          }
        }
      });
    });
  
    // Inser√ß√£o de texto com quebra de linha ao clicar no bot√£o
    document.querySelectorAll('.insert-option').forEach(button => {
      button.addEventListener('click', function () {
        const textarea = document.getElementById(this.dataset.targetId);
        if (textarea) {
          if (textarea.value.trim()) {
            textarea.value += '\n' + this.dataset.text;
          } else {
            textarea.value = this.dataset.text;
          }
        }
      });
    });
  });
  </script>

</body>
</html>